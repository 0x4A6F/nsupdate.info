{% extends "base.html" %}
{% load bootstrap %}

{% block content %}
    <div class="jumbotron">
        <h2>Browser-based Updater</h2>
        <p>
            Host {{ hostname }} will get automatically updated as long as you keep this window open.
        </p>
        <noscript>
            <p class="text-danger">
                The browser based updater only works if javascript is enabled.
            </p>
        </noscript>
        <h2>Updater Status</h2>
        <dl>
            <dt>My IP:</dt>
            <dd><span id="myip"></span> (<span id="myip_timestamp"></span>)</dd>
            <dt>Last update response:</dt>
            <dd><span id="response"></span> (<span id="response_timestamp"></span>)</dd>
        </dl>
    </div>
    <script type="text/javascript">
    // Thanks to 1v3ry for helping with the js code!
    var last_ip = '';

    function format_dt(dt) {
        // return a somehow ISO-like formatted local date / time string,
        // but without timezone, "T", "Z", milliseconds or other stuff.
        function pad(number) {
            return number <= 9 ? '0' + number : number;
        }
        return (
            dt.getFullYear() + '-' + pad(dt.getMonth() + 1) + '-' + pad(dt.getDate()) +
            ' ' +
            pad(dt.getHours()) + ':' + pad(dt.getMinutes()) + ':' + pad(dt.getSeconds())
        );
    }

    function now_str() {
        dt = new Date();
        return format_dt(dt);
    }

    function checkIP() {
        $.get("{% url 'myip' %}")
        .done(function( data ) {
            ip = data;
            $('#myip').text(ip);
            $('#myip_timestamp').text(now_str());
            if(ip != last_ip) {
                $.ajax({
                    url: "{% url 'nic_update' %}",
                    username: "{{ hostname }}",
                    password: "{{ secret }}"
                })
                .done(function( data ) {
                    $('#response').text(data);
                    $('#response_timestamp').text(now_str());
                    last_ip = ip;
                })
                .fail(function( data ) {
                    $('#response').text('update failed');
                    $('#response_timestamp').text(now_str());
                });
            }
        })
        .fail(function( data ) {
            $('#response').text('myip failed');
            $('#response_timestamp').text(now_str());
        });
    }

    $(document).ready(function() {
        checkIP();  // run immediately ...
        setInterval(checkIP, 300000);  // ... then repeat every N ms
    });
    </script>
{% endblock %}
